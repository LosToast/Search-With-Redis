<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Search (Redis)</title>
    <style>
        body { font-family: system-ui, Arial; max-width: 900px; margin: 24px auto; padding: 0 16px; }
        .row { display: flex; gap: 12px; align-items: center; }
        input { width: 100%; padding: 10px 12px; font-size: 16px; }
        button { padding: 10px 12px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .box { position: relative; width: 100%; }
        .suggestions {
            position: absolute; top: 44px; left: 0; right: 0;
            border: 1px solid #ddd; background: white; border-radius: 8px;
            overflow: hidden; display: none; z-index: 10;
        }
        .suggestions div { padding: 10px 12px; cursor: pointer; }
        .suggestions div:hover { background: #f2f2f2; }
        .meta { color: #555; margin-top: 12px; }
        .results { margin-top: 16px; display: grid; gap: 10px; }
        .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
        .card h3 { margin: 0 0 6px 0; font-size: 16px; }
        .muted { color: #666; font-size: 14px; }
        .pager { display: flex; gap: 10px; margin-top: 16px; align-items: center; }
        .error { color: #b00020; margin-top: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>
<h2>Product Search (Redis)</h2>

<div class="row">
    <div class="box">
        <input id="q" placeholder="Search products…" autocomplete="off" />
        <div id="suggestions" class="suggestions"></div>
    </div>
    <button id="searchBtn">Search</button>
</div>

<div class="row" style="margin-top: 12px;">
    <label>Page size:</label>
    <select id="size">
        <option>5</option>
        <option selected>10</option>
        <option>20</option>
        <option>50</option>
    </select>
</div>

<div id="meta" class="meta"></div>
<div id="error" class="error"></div>

<div id="results" class="results"></div>

<div class="pager">
    <button id="prevBtn">Prev</button>
    <span id="pageLabel"></span>
    <button id="nextBtn">Next</button>
</div>

<script>
    // ✅ Change if your backend uses a different port or context-path
    const API_BASE = "http://localhost:8080";

    // ✅ Must match your controller
    const SEARCH_PATH = "/api/v1/products/search";

    // Optional (only if you add autocomplete endpoint)
    const AUTOCOMPLETE_PATH = "/api/v1/products/autocomplete";

    let page = 0;
    let lastQuery = "";
    let lastPageInfo = { first: true, last: false, totalPages: 0, totalElements: 0, size: 10, number: 0 };

    const qEl = document.getElementById("q");
    const sizeEl = document.getElementById("size");
    const resultsEl = document.getElementById("results");
    const metaEl = document.getElementById("meta");
    const errEl = document.getElementById("error");
    const pageLabelEl = document.getElementById("pageLabel");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const suggestionsEl = document.getElementById("suggestions");

    function showError(msg) {
        errEl.textContent = msg || "";
    }

    function escapeHtml(s) {
        return String(s ?? "").replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;").replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function formatPrice(x) {
        if (x === null || x === undefined || Number.isNaN(Number(x))) return "-";
        return Number(x).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString();
    }

    async function fetchJson(url) {
        const res = await fetch(url);
        const txt = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}\n${txt}`);
        try { return JSON.parse(txt); } catch { return txt; }
    }

    function updatePager(info) {
        pageLabelEl.textContent = `Page ${info.number + 1} / ${Math.max(info.totalPages, 1)}`;
        prevBtn.disabled = info.first === true;
        nextBtn.disabled = info.last === true || info.totalPages === 0;
    }

    async function doSearch(resetPage) {
        showError("");
        if (resetPage) page = 0;

        const q = qEl.value.trim();
        const size = Number(sizeEl.value);

        lastQuery = q;

        const url = new URL(API_BASE + SEARCH_PATH);
        url.searchParams.set("q", q);
        url.searchParams.set("page", page);
        url.searchParams.set("size", size);

        try {
            const data = await fetchJson(url.toString());

            // Your JSON is a Page-like object:
            // content, number, size, totalElements, totalPages, first, last, etc.
            const content = Array.isArray(data.content) ? data.content : [];

            lastPageInfo = {
                number: data.number ?? page,
                size: data.size ?? size,
                totalElements: data.totalElements ?? content.length,
                totalPages: data.totalPages ?? 0,
                first: data.first ?? (page === 0),
                last: data.last ?? false
            };

            // ensure UI page syncs with backend
            page = lastPageInfo.number;

            metaEl.textContent =
                `Query="${q}" | Total=${lastPageInfo.totalElements.toLocaleString()} | PageSize=${lastPageInfo.size}`;

            updatePager(lastPageInfo);

            resultsEl.innerHTML = content.map(p => {
                const name = p.name ?? "(no name)";
                const category = p.category ?? "-";
                const price = p.price;
                const id = p.id ?? "-";
                const desc = p.description ?? "";
                const createdAt = p.createdAt;

                return `
          <div class="card">
            <h3>${escapeHtml(name)}</h3>
            <div class="muted">ID: ${escapeHtml(id)} • Category: ${escapeHtml(category)} • Price: ${escapeHtml(formatPrice(price))}</div>
            <div class="muted">Created: ${escapeHtml(formatDate(createdAt))}</div>
            <div style="margin-top:8px;">${escapeHtml(desc)}</div>
          </div>
        `;
            }).join("");

            if (content.length === 0) {
                resultsEl.innerHTML = `<div class="muted">No results.</div>`;
            }
        } catch (e) {
            showError(String(e));
            resultsEl.innerHTML = "";
            metaEl.textContent = "";
            pageLabelEl.textContent = "";
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        }
    }

    // ----------------- Optional autocomplete -----------------
    function setSuggestions(items) {
        if (!items || items.length === 0) {
            suggestionsEl.style.display = "none";
            suggestionsEl.innerHTML = "";
            return;
        }
        suggestionsEl.innerHTML = items.map(x => `<div>${escapeHtml(x)}</div>`).join("");
        suggestionsEl.style.display = "block";

        [...suggestionsEl.querySelectorAll("div")].forEach(div => {
            div.addEventListener("click", () => {
                qEl.value = div.textContent;
                setSuggestions([]);
                doSearch(true);
            });
        });
    }

    let acTimer = null;
    async function doAutocomplete() {
        // If you don't have autocomplete endpoint yet, disable it:
        // return;

        const q = qEl.value.trim();
        if (q.length < 2) {
            setSuggestions([]);
            return;
        }

        const url = new URL(API_BASE + AUTOCOMPLETE_PATH);
        url.searchParams.set("q", q);
        url.searchParams.set("limit", "10");

        try {
            const data = await fetchJson(url.toString());
            const items = Array.isArray(data)
                ? data.map(x => typeof x === "string" ? x : (x.string ?? x.value ?? x.suggestion ?? "")).filter(Boolean)
                : [];
            setSuggestions(items.slice(0, 10));
        } catch {
            setSuggestions([]);
        }
    }

    // ----------------- Event handlers -----------------
    document.getElementById("searchBtn").addEventListener("click", () => doSearch(true));

    qEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch(true);
        if (e.key === "Escape") setSuggestions([]);
    });

    qEl.addEventListener("input", () => {
        clearTimeout(acTimer);
        acTimer = setTimeout(doAutocomplete, 150);
    });

    document.addEventListener("click", (e) => {
        if (!suggestionsEl.contains(e.target) && e.target !== qEl) setSuggestions([]);
    });

    prevBtn.addEventListener("click", () => {
        if (!lastPageInfo.first) {
            page = Math.max(0, page - 1);
            doSearch(false);
        }
    });

    nextBtn.addEventListener("click", () => {
        if (!lastPageInfo.last) {
            page = page + 1;
            doSearch(false);
        }
    });

    sizeEl.addEventListener("change", () => doSearch(true));

    // initial search (optional)
    // doSearch(true);
</script>
</body>
</html>
